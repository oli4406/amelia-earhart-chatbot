<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: BackEnd/services/flightService.js</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">

    <h1 class="page-title">Source: BackEnd/services/flightService.js</h1>

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>import { getJson } from 'serpapi';

const controller = new AbortController();
const timeout = setTimeout(() => controller.abort(), 10000);

/**
 * Searches for flights using the SerpAPI Google Flights engine.
 * Tries multiple dates if no departure date is given.
 * Supports filtering, storting, price caps, and airline inclusion/exclusion.
 * @async
 * @function searchFlights
 * @param {string} origin - IATA of departure airport(s), comma-separated.
 * @param {string} destination - Destination IATA code.
 * @param {string} departure_date - YYYY-MM-DD departure.
 * @param {string} flight_type - 1=one-way, 2=round-trip.
 * @param {string} [return_date] - YYYY-MM-DD return date.
 * @param {string} [exclude_airlines] - Comma-separated airline codes to exclude.
 * @param {string} [include_airlines] - Comma-separated airline codes to include.
 * @param {string} [max_price] - Upper price limit.
 * @param {string} [sort_by] - Defines the sorting order of the results. 1=top flights (default), 2=price, 3=departure time, 4=arrival time, 5=duration, 6=emissions
 * @returns {Promise&lt;Object[]|null>} List of flights or null on error.
 */
export async function searchFlights(origin, destination, departure_date, flight_type, return_date, exclude_airlines, include_airlines, max_price, sort_by) {
  console.log(`Searching flights from ${origin} to ${destination} departing on ${departure_date} returning on ${return_date || 'N/A'}`);

  try {
    const SERPAPI_KEY = globalThis.process.env.SERPAPI_API_KEY;

    if (!SERPAPI_KEY) {
      console.error("SERP API KEY NOT SET")
      return null
    }

    if (departure_date &amp;&amp; !/^\d{4}-\d{2}-\d{2}$/.test(departure_date)) {
      throw new Error("Invalid departure_date format");
    }

    const request_data = {
      engine: "google_flights",
      api_key: SERPAPI_KEY,
      type: flight_type,
      currency: "GBP",
      departure_id: "LGW,LHR" // default to gatwick and heathrow if not given
    };

    if (origin) { request_data['departure_id'] = origin};
    if (destination) { request_data['arrival_id'] = destination};
    if (departure_date) { request_data['outbound_date'] = departure_date};
    if (return_date) { request_data['return_date'] = return_date};
    if (exclude_airlines) { request_data['exclude_airlines'] = exclude_airlines
    } else if (include_airlines) { request_data['include_airlines'] = include_airlines};
    if (max_price) { request_data['max_price'] = max_price};
    if (sort_by) { request_data['sort_by'] = sort_by};

    // If departure_date is not specified, try up to 5 times, incrementing the date each time
    let attempts = 0;
    let flights = [];
    if (!departure_date) {
      let date = new Date();
      while (attempts &lt; 5 &amp;&amp; (!flights || flights.length === 0)) {
        // Format date as YYYY-MM-DD
        const formattedDate = date.toISOString().split('T')[0];
        request_data['outbound_date'] = formattedDate;
        console.log(`Attempt ${attempts + 1}: Trying departure_date ${formattedDate}`);
        const json = await getJson(request_data);
        flights = json.best_flights || json.flights || [];
        if (flights &amp;&amp; flights.length > 0) {
          console.log(`Flights found on attempt ${attempts + 1}`);
          break;
        }
        // Increment date by one day
        date.setDate(date.getDate() + 1);
        attempts++;
      }
      return flights;
    } else {
      const json = await getJson({
        ...request_data,
        signal: controller.signal
      });

      const status = json.search_metadata.status;
      const error = json.error;

      if (status === "Success") {
        if (error === "Google Flights hasn't returned any results for this query.") {
          console.error(error)
          return []
        } else {
          return json.best_flights || json.flights || [];
        }
      }
    }
  } catch (error) {
    console.error(`Error searching flights: ${error}`);
    return null;
  } finally {
    clearTimeout(timeout);
  }
}

export default searchFlights;
</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Modules</h3><ul><li><a href="module-components_ChatField.html">components/ChatField</a></li><li><a href="module-components_ChatPage.html">components/ChatPage</a></li><li><a href="module-components_ForgotPassword.html">components/ForgotPassword</a></li><li><a href="module-components_History.html">components/History</a></li><li><a href="module-components_Home.html">components/Home</a></li><li><a href="module-components_Login.html">components/Login</a></li><li><a href="module-components_NavBar.html">components/NavBar</a></li><li><a href="module-components_Register.html">components/Register</a></li><li><a href="module-components_Settings.html">components/Settings</a></li><li><a href="module-components_TypingIndicator.html">components/TypingIndicator</a></li><li><a href="module-config_cors.html">config/cors</a></li><li><a href="module-config_database.html">config/database</a></li><li><a href="module-config_gemini.html">config/gemini</a></li><li><a href="module-main.html">main</a></li><li><a href="module-routes_auth.html">routes/auth</a></li><li><a href="module-routes_chat.html">routes/chat</a></li><li><a href="module-routes_history.html">routes/history</a></li><li><a href="module-routes_user.html">routes/user</a></li><li><a href="module-server.html">server</a></li><li><a href="module-services_airportService.html">services/airportService</a></li><li><a href="module-services_chatService.html">services/chatService</a></li><li><a href="module-services_responseService.html">services/responseService</a></li></ul><h3>Global</h3><ul><li><a href="global.html#TokenVerificationSecret">TokenVerificationSecret</a></li><li><a href="global.html#requestLogger">requestLogger</a></li><li><a href="global.html#searchFlights">searchFlights</a></li></ul>
</nav>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc/jsdoc">JSDoc 4.0.5</a> on Mon Dec 15 2025 15:44:47 GMT+0000 (Greenwich Mean Time)
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
